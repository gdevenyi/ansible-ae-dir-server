---

# Add system accounts/groups
#---------------------------------------------------------------------------

- name: "Add local system groups needed on {{ openldap_role }}"
  group:
    name: "{{ item.key }}"
    gid: "{{ item.value.gid_number }}"
    state: present
    system: yes
  with_dict:
    "{{ aedir_ldapi_services }}"
  when: openldap_role in item.value.roles

- name: "Add local system accounts needed on {{ openldap_role }}"
  user:
    name: "{{ item.key }}"
    comment: "{{ item.value.description }}"
    uid: "{{ item.value.uid_number }}"
    group: "{{ item.value.gid_number }}"
    shell: "{{ aedir_nologin_shell }}"
    state: present
    system: yes
    createhome: no
    non_unique: no
    home: "{{ item.value.get('home_directory', '/home/'+item.key) }}"
  with_dict:
    "{{ aedir_ldapi_services }}"
  when: openldap_role in item.value.roles

- name: "Create home directories for some system accounts on {{ openldap_role }}"
  file:
    path: "{{ item.value.home_directory }}"
    state: directory
    owner: "{{ item.value.uid_number }}"
    group: "{{ item.value.gid_number }}"
    mode: u=rwx,g=,o=
  with_dict:
    "{{ aedir_ldapi_services }}"
  when: openldap_role in item.value.roles and 'home_directory' in item.value

# Remove system accounts/groups
#---------------------------------------------------------------------------

- name: "Remove local system accounts not needed on {{ openldap_role }}"
  user:
    name: "{{ item.key }}"
    state: absent
  with_dict:
    "{{ aedir_ldapi_services }}"
  when: openldap_role not in item.value.roles

- name: "Remove local system groups not needed on {{ openldap_role }}"
  group:
    name: "{{ item.key }}"
    state: absent
  with_dict:
    "{{ aedir_ldapi_services }}"
  when: openldap_role not in item.value.roles
