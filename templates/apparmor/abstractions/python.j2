# AppArmor abstraction for Python scripts installed in virtual env {{ apparmor_aedir_prefix }}
# {{ ansible_managed }}

  #include <ae-dir/abstractions/base>
  #include <ae-dir/abstractions/nameservice>
  #include <ae-dir/abstractions/ldapclient>

  # grant read access to check whether FIPS-compliant crypto is available
  @{PROC}/sys/crypto/fips_enabled r,

  # Grant access for dynamic linking of OpenLDAP client libs
  {{ openldap_path.libdir }}/ r,
  {{ openldap_path.libdir }}/lib{ldap,lber}* mr,

  # grant read access to system-wide Python modules
  /usr/lib{,32,64}/python{{ apparmor_aedir_python_version }}/ r,
  /usr/lib{,32,64}/python{{ apparmor_aedir_python_version }}/**.{pyc,so} mr,
  /usr/lib{,32,64}/python{{ apparmor_aedir_python_version }}/**.{egg,py,pth} r,
  /usr/lib{,32,64}/python{{ apparmor_aedir_python_version }}/{site,dist}-packages/ r,
{% if apparmor_aedir_python_version[0]=="3" %}
  # grant read access to Python 3 shared libs
  /usr/lib{,32,64}/python3.[0-9]/lib-dynload/*.so mr,
{% endif %}

{% if apparmor_lsb_id=="Debian" %}
  # some special rules for Debian's shared Python module directories
  # shared python paths and config
  /usr/share/{pyshared,pycentral,python-support}/**      r,
  /{var,usr}/lib/{pyshared,pycentral,python-support}/**  r,
  /usr/lib/{pyshared,pycentral,python-support}/**.so     mr,
  /var/lib/{pyshared,pycentral,python-support}/**.pyc    mr,
  /usr/{,local/}lib/python3/dist-packages/**.so          mr,
  /etc/python{{ apparmor_aedir_python_version }}/ r,
  /etc/python{{ apparmor_aedir_python_version }}/sitecustomize.py r,
{% endif %}

{% if apparmor_lsb_id!="SUSE" %}
  # Separate Python virtual env on {{ apparmor_lsb_id }}
  {{ apparmor_apparmor_aedir_python_sitepackages }}/ r,
  {{ apparmor_apparmor_aedir_python_sitepackages }}/** r,
  {{ apparmor_aedir_prefix }}/pyvenv.cfg r,
  {{ apparmor_aedir_prefix }}/lib/python{{ apparmor_aedir_python_version }}/ r,
  {{ apparmor_aedir_prefix }}/lib/python{{ apparmor_aedir_python_version }}/orig-prefix.txt r,
  {{ apparmor_aedir_prefix }}/lib/python{{ apparmor_aedir_python_version }}/**.py{,c,o} r,
  {{ apparmor_aedir_prefix }}/lib/python{{ apparmor_aedir_python_version }}/**.so* rm,
{% endif %}

  # Python logging config file
  {{ apparmor_aedir_etc }}/ae-logging.conf r,
