#!/bin/sh

# exit on error
set -e

# be strict on permissions
umask 0077

TIMESTAMP="$(date +%Y%m%d%H%M%S)"
NEW_CSR_FILE="{{ openldap_conf_prefix }}/tls/{{ openldap_service_fqdn }}.csr-${TIMESTAMP}"
NEW_KEY_FILE="{{ openldap_conf_prefix }}/tls/{{ openldap_service_fqdn }}.key-${TIMESTAMP}"

# Generate new CSR file with OpenSSL
/usr/bin/openssl req \
  -config {{ openldap_conf_prefix }}/tls/gen_csr.cnf \
  -batch \
  -new \
  -nodes \
  -out "${NEW_CSR_FILE}" \
  -keyout "${NEW_KEY_FILE}" \
  -reqexts "csr_extensions"

# Display new CSR file
/usr/bin/openssl req \
  -in "${NEW_CSR_FILE}" \
  -noout \
  -text \
  -nameopt rfc2253
