#!/bin/sh

# Don't use uninitialized vars
set -o nounset
# After here exit on any error
set -e

# current timestamp
DATETIME="$(date +%Y%m%d%H%M%S)"

# strict permissions
umask 077

DB_SUFFIXES="$({{ openldap_path.bin }}/ldapsearch -Q -LLL -b 'cn=config' -s one '(olcSuffix=*)' olcSuffix | grep olcSuffix | cut -d' ' -f2)"

for db_suffix in ${DB_SUFFIXES}
do
  export_file="{{ openldap_backup_path }}/${db_suffix}-${DATETIME}.ldif"
  echo "Exporting ${db_suffix} to ${export_file}"
  {{ openldap_path.slapd_exec }} \
    -T cat \
    -f "{{ openldap_slapd_conf }}" \
    -b "${db_suffix}" \
    -l "${export_file}"
done

echo "Remove backup files older than {{ openldap_backup_max_days }} days"
find "{{ openldap_backup_path }}" -type f -name "*.ldif*" -mtime +{{ openldap_backup_max_days }} -delete

{% if openldap_backup_compressor %}
echo "Compress LDIF files"
{{ openldap_backup_compressor }} {{ openldap_backup_path }}/*.ldif
{% endif %}
