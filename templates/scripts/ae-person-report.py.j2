#!{{ aedir_python }}
# -*- coding: utf-8 -*-
"""
Generates a report of aePerson entries referenced by active aeUser entries
"""

from __future__ import absolute_import

__version__ = '0.0.3'

import sys, os, csv, pprint

# set LDAPRC env var *before* importing ldap0
os.environ['LDAPRC'] = '/opt/ae-dir/etc/ldap.conf'
import ldap0
from ldap0.controls.deref import DereferenceControl

import aedir

USER_ATTRS = ['1.1']

AEPERSON_ATTRS = [
    'sn',
    'givenName',
    'cn',
    'mail',
    'employeeNumber',
    'telephoneNumber',
    'mobile',
    'homePhone',
    'aeDept',
    'ou',
    'departmentNumber',
    'o',
    'street',
    'l',
    'c',
]

# dereference the AEPERSON_ATTRS from the aeUser entry via attribute aePerson
DEREF_CONTROL = DereferenceControl(True, {'aePerson': AEPERSON_ATTRS})


#---------------------------------------------------------------------------
# main()
#---------------------------------------------------------------------------

ldap_conn = aedir.AEDirObject(None)

msg_id = ldap_conn.search(
    ldap_conn.find_search_base(),
    ldap0.SCOPE_SUBTREE,
    '(&(objectClass=aeUser)(aeStatus=0))',
    attrlist=USER_ATTRS,
    serverctrls = [DEREF_CONTROL],
)

person_dict = {}

for res in ldap_conn.results(msg_id,add_ctrls=1):
    for dn, entry, controls in res.data:
        # process dn and entry
        if controls:
            deref_control = controls[0]
            deref_dn, deref_entry = deref_control.derefRes['aePerson'][0]
            person_dict[deref_dn.lower()] = dict([
                (at,'|'.join(av))
                for at,av in deref_entry.items()
            ])

csv_writer = csv.DictWriter(
    sys.stdout,
    AEPERSON_ATTRS,
    dialect='excel'
)
csv_writer.writerow(
    dict([
        (at, at)
        for at in AEPERSON_ATTRS
    ])
)
csv_writer.writerows(person_dict.values())
