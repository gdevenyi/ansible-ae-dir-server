# -*- coding: utf-8 -*-
# {{ ansible_managed }}
#
# Some local configuration tweaks for Ã†-DIR

# imports from Python's standard lib
import sys, os, re

# python-ldap
import ldap

# internal configuration import
import web2ldapcnf.hosts
import web2ldapcnf.monitor
import w2lapp.schema.syntaxes

#-----------------------------------------------------------------------

# Which IP addresses are allowed to access monitor page
web2ldapcnf.monitor.access_allowed = [
  '127.0.0.0/255.0.0.0',
  '::1',
  'fe00::0',
  '10.0.0.0/255.0.0.0',
#  '0.0.0.0/0.0.0.0','::0',
]

#-----------------------------------------------------------------------
# Tweak some class attributes of AE-DIR plugin classes
#-----------------------------------------------------------------------

import w2lapp.schema.plugins.aedir

w2lapp.schema.plugins.aedir.AETicketId.reObj = re.compile('^[A-Z]+-[0-9]+$')
w2lapp.schema.plugins.aedir.AETicketId.html_tmpl = '<a href="https://issues.example.com/browse/{av}">{av}</a>'

w2lapp.schema.plugins.aedir.AEHostname.html_tmpl = """{av}
  <a href="https://foreman.example.com/hosts/{av}">foreman</a>
  <a href="http://checkmk.example.com/network/check_mk/index.py?start_url=%2Fnetwork%2Fcheck_mk%2Fview.py%3Fview_name%3Dhost%26host%3D{av}">check_mk</a>
"""

w2lapp.schema.plugins.aedir.AEDisplayNamePerson.compose_templates = (
  '{givenName} {sn}/{uniqueIdentifier}/{departmentNumber}',
  '{givenName} {sn}/{uniqueIdentifier})',
  '{givenName} {sn}',
)

# Quick&dirty set slapd's CA cert as trusted cert in web2ldap
web2ldapcnf.hosts.ldap_def['_'].tls_options[ldap.OPT_X_TLS_CACERTFILE] = '{{ openldap_cacert_pathname }}'

# Set select list on connect landing page
web2ldapcnf.hosts.ldap_uri_list = [
  (
    'ldapi://%2Fusr%2Flocal%2Fopenldap%2Fvar%2Frun%2Fldapi/ou=ae-dir????bindname=',
    u'Local AE-DIR (LDAPI, needs login)'
  ),
]

w2lapp.schema.syntaxes.syntax_registry.registerAttrType(
  w2lapp.schema.plugins.aedir.AEPersonManager.oid,[
    '0.9.2342.19200300.100.1.10', # manager
  ],
  structural_oc_oids=[
    w2lapp.schema.plugins.aedir.AE_PERSON_OID, # aePerson
  ],
)

import w2lapp.schema.plugins.posixautogen
#w2lapp.schema.plugins.posixautogen.HomeDirectory.homeDirectoryTemplate = '/home/{uid}'
w2lapp.schema.plugins.posixautogen.AutogenUIDNumber.minNewValue = {{ aedir_min_uid }}L
w2lapp.schema.plugins.posixautogen.AutogenUIDNumber.maxNewValue = {{ aedir_max_uid }}L
w2lapp.schema.plugins.posixautogen.AutogenGIDNumber.minNewValue = {{ aedir_min_gid }}L
w2lapp.schema.plugins.posixautogen.AutogenGIDNumber.maxNewValue = {{ aedir_max_gid }}L
