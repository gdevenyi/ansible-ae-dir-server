#!/bin/sh
# shell wrapper script for extracting/decrypting oathToken PIN
# {{ ansible_managed }}

# disable use of ldap.conf
LDAPNOINIT=1
export LDAPNOINIT

# explicitly use specific libldap
LD_LIBRARY_PATH="{{ openldap_path.libdir }}:${LD_LIBRARY_PATH}"
export LD_LIBRARY_PATH

# some env vars set for Python interpreter
{% for evar in oathldap_aedir_python_env %}
{{ evar.name }}={{ evar.value }}
export {{ evar.name }}
{% endfor %}

{{ oathldap_aedir_python }} -m oathldap_tool.cli decpin \
  --ldap-url '{{ oathldap_openldap_ldapi_uri }}/{{ oathldap_aedir_suffix }}' \
  --key-path '{{ oathldap_oath_ldap_keys_dir }}' \
  --token-id "$1"
