---
# defaults file for roles/ae-dir

#---------------------------------------------------------------------------
# AE-DIR parameters
#---------------------------------------------------------------------------

# base DN / search root for AE-DIR entries
aedir_suffix: "ou=ae-dir"

# POSIX-UID number range served by AE-DIR
aedir_min_uid: 30000
aedir_max_uid: 59999

# POSIX-GID number range served by AE-DIR
aedir_min_gid: 30000
aedir_max_gid: 59999

# fixed primary POSIX-GID in all posixAccount entries
aedir_global_gid: "{{ aedir_min_uid }}"

# Parameters for generating user names
aedir_username_length: 4
aedir_username_gen_trials: 15

# Some paths for tools
aedir_prefix: "/opt/ae-dir"
aedir_bin: "/opt/ae-dir/bin"
aedir_rundir: "/opt/ae-dir/run"

# regex patterns for enforcing naming conventions (substring match!)
# Important notes:
# - patterns are also used as substrings of more complex patterns => do not enclose in ^ and $
# - you should only *relax* patterns for an existing deployment with existing entries!
# attribute 'cn'
aedir_aezone_cn_regex: "[a-z0-9]+"
aedir_aegroup_cn_regex: "[a-z0-9]?[a-z0-9-]+"
aedir_aesudorule_cn_regex: "{{ aedir_aegroup_cn_regex }}"
aedir_aesrvgroup_cn_regex: "{{ aedir_aegroup_cn_regex }}"
# attribute 'uid'
aedir_aeuser_uid_regex: "[a-z]{{ '{' }}{{ aedir_username_length }}{{ '}' }}+"
aedir_aeservice_uid_regex: "[a-zA-Z0-9_.-]+"
# attribute 'aeTicketId'
aeticketid_regex: "[A-Z]+-[0-9]+"

# ticket identifier of initial ldapadd
aedir_init_ticket_id: "INIT-42"

# Usernames and POSIX-UID/-GID numbers for system accounts of services
# running on providers and accessing AE-DIR via LDAPI
# Important notes:
# - uid_number/gid_number should be outside aedir_min_uid/aedir_max_uid range defined above
# - user names must match aedir_aeservice_uid_regex pattern defined above
# - do not remove items after initializing a AE-DIR deployment
# - special care needed for usernames used in OpenLDAP ACLs
aedir_ldapi_services:
  # system user which must match UID/GID slapd is running as
  - uid: ldap
    cn: OpenLDAP slapd demon user
    uid_number: 108
    gid_number: 113
    description: The system user for running OpenLDAP server process (slapd)
  # system user for password self-service web application
  # uid is referenced in OpenLDAP ACLs!
  - uid: ae-dir-pwd
    cn: Password self-service application
    uid_number: 998
    gid_number: 998
    description: The system user allowed to set attributes during user password reset (msPwdResetObject) over LDAPI
  # system user for sync processes
  - uid: ae-dir-peoplesync
    cn: Personnel data sync process
    uid_number: 999
    gid_number: 999
    description: The system user allowed to maintain aePerson entries over LDAPI
  # system user for OTP registration/enrollment web application
  # uid is referenced in OpenLDAP ACLs!
  - uid: ae-dir-otpenroll
    cn: 2FA enrollment application
    uid_number: 997
    gid_number: 997
    description: The system user allowed to maintain aePerson entries over LDAPI
  # system user for 2FA web application
  # uid is referenced in OpenLDAP ACLs!
  - uid: ae-dir-otpverify
    cn: OATH-LDAP validator demon
    uid_number: 996
    gid_number: 996
    description: The system user allowed to read shared secrets (OATH-LDAP)

# List of aeZone entries to be added to ae-dir-base.ldif
aedir_init_aezones:
  people:
    ticket_id: "{{ aedir_init_ticket_id }}"
    description: "People and orga entries"
  office:
    ticket_id: "{{ aedir_init_ticket_id }}"
    description: "Zone for primary office users and groups"
  otp:
    ticket_id: "{{ aedir_init_ticket_id }}"
    description: "Zone for OTP tokens (OATH-LDAP)"

# List of aePerson entries to be added to ae-dir-base.ldif
aedir_init_aepersons:
  INIT-PERSON-ID-42:
    given_name: Michael
    sur_name: Ströder
    mail: michael@stroeder.com

# List of aeUser entries to be added to ae-dir-base.ldif
# - user names must match aedir_aeservice_uid_regex pattern defined above
# - unique_identifier has to be an entry in aedir_init_aepersons
aedir_init_aeadmins:
  - uid: msin
    unique_identifier: INIT-PERSON-ID-42
    description: initial Æ-DIR admin
    ticket_id: "{{ aedir_init_ticket_id }}"

aedir_hosts:
  # inventory host names of *all* provider hosts
  provider: "{{ groups['ae-dir-providers'] }}"
  # inventory host names of *all* consumer hosts
  consumer: "{{ groups['ae-dir-consumers'] }}"

#---------------------------------------------------------------------------
# OpenLDAP parameters
#---------------------------------------------------------------------------

# replica role, must be either 'provider' or 'consumer'
openldap_role: "consumer"

# which Debian repo to use for LTB OpenLDAP builds
ltb_openldap_repo_source: "deb http://ltb-project.org/debian/{{ ansible_distribution_release }} {{ ansible_distribution_release }} main"
ltb_openldap_repo_key: "http://ltb-project.org/wiki/lib/RPM-GPG-KEY-LTB-project"

# default FQDN in LDAP service URL
openldap_service_fqdn: "{{ inventory_hostname }}"

# Some paths
openldap_prefix: "/usr/local/openldap"
openldap_bin: "{{ openldap_prefix }}/bin"
openldap_conf_prefix: "{{ openldap_prefix }}/etc/openldap"
openldap_schema_prefix: "{{ openldap_prefix }}/etc/openldap/schema"
openldap_sbin: "{{ openldap_prefix }}/sbin"
openldap_defaults: "/etc/default/slapd"
openldap_rundir: "{{ openldap_prefix }}/var/run"
openldap_data: "{{ openldap_prefix }}/var/openldap-data"
openldap_conf_file: "{{ openldap_conf_prefix }}/slapd.conf"
openldap_ldapi_socket: "{{ openldap_rundir }}/ldapi"
openldap_ldapi_uri: "ldapi://{{ openldap_ldapi_socket|urlencode|replace('/','%2F') }}"

# Directories with dynamically loadable modules
openldap_module_paths:
  - "{{ openldap_prefix }}/libexec/openldap"

# All additional schema files needed
openldap_schema_files:
  - ae-dir.schema
  - draft-findlay-ldap-groupofentries.schema
  - draft-stroeder-mailboxrelatedobject.schema
  - draft-stroeder-namedobject.schema
  - mspwdreset.schema
  - oath-ldap.schema
  - openssh-lpk_openldap.schema
  - rfc2307bis.schema
  - stroeder.com-oid-macros.schema
  - stroeder.com.schema
  - sudoers.schema

# List of servers to be added to rootDSE attribute altServer (see RFC 4512)
openldap_rootdse_alt_servers: "{{ aedir_hosts[openldap_role] }}"

# The CA certificate file for validating the server certs
openldap_cacert_filename: "slapd-cacerts.pem"

# Suffix expected in subject-DN of server and client certs
# for authz-regexp directive and pkiUser/seeAlso attributes
openldap_tls_cert_suffix: "OU=ITS,O=Example,C=DE"

# The server certificate and key files
openldap_cert_filename: "{{ openldap_service_fqdn }}.crt"
openldap_key_filename: "{{ openldap_service_fqdn }}.key"

# The full path names on the target system
openldap_cacert_pathname: "{{ openldap_conf_prefix }}/tls/{{ openldap_cacert_filename }}"
openldap_cert_pathname: "{{ openldap_conf_prefix }}/tls/{{ openldap_service_fqdn }}.crt"
openldap_key_pathname: "{{ openldap_conf_prefix }}/tls/{{ openldap_service_fqdn }}.key"

# for generating DH parameters for perfect forward secrecy
openldap_dhparam_pathname: "{{ openldap_conf_prefix }}/tls/slapd.dhparam"
openldap_dhparam_numbits: 2048

# subject alternative names for gen_csr.sh in OpenSSL syntax
openldap_csr_subjectaltnames:
  - "DNS:{{ openldap_service_fqdn }}"

# which messages to send to syslog
# normal for production: stats
openldap_log_level: "stats"

# how many worker threads are started
# RAM needed per thread: 4MB on 32 bit systems, 8MB on 64 bit systems
# rule-of-thumb: 4 per real CPU core
openldap_threads: 8

# Database parameters
openldap_db_accesslog_maxsize: 4000000
openldap_db_um_maxsize: 4000000

# list of syncrepl providers used on a certain replica
openldap_syncrepl_providers: "{{ aedir_hosts['provider']|map('extract', hostvars, 'openldap_service_fqdn')|list }}"

#---------------------------------------------------------------------------
# web2ldap parameters
#---------------------------------------------------------------------------

# Jinja template names used
aedir_web2ldap_cnf_local: "web2ldapcnf_local.py.j2"
aedir_web2ldap_connect_template: "web2ldap_connect.html.j2"
